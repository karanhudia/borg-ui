# Simplified Docker Compose - Zero Configuration Required!
#
# Auto-configured settings:
# - SECRET_KEY: Auto-generated on first run and persisted
# - DATABASE_URL: Auto-derived from data_dir (/data)
# - BORG_CONFIG_PATH: Auto-derived from data_dir
# - LOG_LEVEL: Defaults to INFO
#
# Users configure backup repositories in borg config (local or SSH)
# No need for borg_backups volume - repositories can be anywhere!

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      args:
        - APP_VERSION=${APP_VERSION:-local-dev}
    container_name: borg-web-ui
    restart: unless-stopped

    ports:
      - "${PORT:-8081}:${PORT:-8081}"

    volumes:
      # Single data volume for all persistent data
      - borg_data:/data:rw

      # Borg cache volume for persistent repository caches
      # Prevents cache loss on container updates/rebuilds
      - borg_cache:/home/borg/.cache/borg:rw

      # System volumes (read-only)
      - /etc/cron.d:/etc/cron.d:ro
      - /etc/localtime:/etc/localtime:ro

      # Host filesystem mount for local-style repository access
      # ‚ö†Ô∏è DEFAULT: Full root access enabled for DEVELOPMENT/TESTING ONLY
      # WARNING: This gives the container read/write access to your entire filesystem
      # For production use, replace with specific directory mounts (see examples below)
      - ${LOCAL_STORAGE_PATH:-/}:/local:rw
      #
      # üîí PRODUCTION EXAMPLES (recommended - comment out the line above and use these):
      #
      # Example 1: Mount your home directory (replace with your actual path)
      # - /home/yourusername:/local:rw
      #
      # Example 2: Mount specific backup directories (recommended for servers)
      # - /mnt/data:/local:rw
      # - /var/www:/local/www:ro  # Read-only if only backing up, not restoring here
      #
      # Example 3: Mount multiple directories (safest approach)
      # - /home/yourusername/documents:/local:rw
      # - /opt/myapp:/local/myapp:rw

      # OPTIONAL: Docker socket for container management in pre/post backup hooks
      # Uncomment to allow pre/post backup scripts to control Docker containers
      # Common use case: Stop database containers before backup, restart after
      # WARNING: This gives the container access to your host's Docker daemon
      # Security: Mount as read-only (:ro) when possible, but some operations need :rw
      # See docs/docker-hooks.md for usage examples and security considerations
      # - /var/run/docker.sock:/var/run/docker.sock:rw

    environment:
      # Optional overrides (all have smart defaults)
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - PORT=${PORT:-8081}
      # Timezone configuration (defaults to host timezone via /etc/localtime mount)
      # Override if needed: TZ=Asia/Kolkata, TZ=America/New_York, etc.
      - TZ=${TZ:-}
      # User/Group ID for file permissions (LinuxServer.io style)
      - PUID=${PUID:-1001}
      - PGID=${PGID:-1001}
      # Uncomment to override defaults:
      # - SECRET_KEY=your-custom-secret-key
      # - LOG_LEVEL=DEBUG

    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:$${PORT:-8081}/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    networks:
      - borg_network

networks:
  borg_network:
    name: borg_network
    driver: bridge

# Persistent data volumes
volumes:
  borg_data:
    name: borg_data
    driver: local
    # Optional: Mount to custom location on host
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /mnt/storage/borg-data

  borg_cache:
    name: borg_cache
    driver: local
    # Optional: Mount to custom location on host
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /mnt/storage/borg-cache
